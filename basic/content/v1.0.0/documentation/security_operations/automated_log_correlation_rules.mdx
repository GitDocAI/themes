This documentation page provides a comprehensive guide to understanding and configuring Automated Log Correlation Rules in UTMStack. These rules are essential for real-time threat detection, incident response, and maintaining compliance by automatically analyzing and correlating log data from various sources.

---

## Automated Log Correlation Rules

UTMStack is a Unified Threat Management Platform that delivers essential security services, including Log Management (SIEM), Threat Detection and Response, and Real-time Correlation. Automated Log Correlation Rules are a critical component of UTMStack's security operations, designed to proactively identify and alert on potential security incidents.

### What are Correlation Rules?

Correlation rules in UTMStack are predefined frameworks that aid analysts in detecting network threats through automated log analysis. These rules swiftly identify potential security incidents by processing data in real time, even before ingestion. Each rule, defined by fields such as reference name and severity, generates alerts to notify security personnel of varying threat levels.

UTMStack's threat detection engine leverages several rule-based correlation systems, scanners, and AI-powered machine learning algorithms. The platform utilizes a vast pool of over 128,000 detection rules, which aggregate, correlate, and analyze log data, network traffic, and system internal activity generated by on-premises, cloud devices, and SaaS applications. This robust system is crucial for maintaining network security and compliance within UTMStack environments.

### The UTMStack Correlation Engine

The UTMStack correlation engine was built from scratch to analyze data before ingestion, maximizing real-time correlation capabilities. This design ensures prompt threat detection and response by processing security events as they occur.

#### Open Source vs. Enterprise Version

While the core correlation engine is fundamental to UTMStack, the Enterprise version offers enhanced features that benefit enterprises and Managed Security Service Providers (MSPs). These include:
*   Support
*   Faster correlation
*   Frequent threat intelligence updates
*   Artificial Intelligence

### Defining Correlation Rules

Correlation rules are configured using a structured format, typically defining various parameters that dictate how logs are analyzed and what constitutes a security event.

#### Fields Reference

Each correlation rule is defined by a set of fields:

*   **name**: The identifier for the alerts generated by the rule.
*   **severity**: The severity level of the alerts. Possible values include `Low`, `Medium`, `High`.
*   **description**: A detailed explanation that will appear in the generated alerts.
*   **solution**: Specifies a known solution or recommended action for the detected incident.
*   **category**: A grouping category for the alert.
*   **tactic**: Indicates if the detected incident fits into known attack tactics (e.g., MITRE ATT&CK tactics).
*   **dataTypes**: An array of string values specifying the data types the rule applies to. Only logs with matching `dataType` fields will be processed by this rule.
*   **reference**: A list of URLs providing more information about the attack or incident.
*   **frequency**: How often, in seconds, the rule should check for the defined conditions.
*   **cache**: This field declares that the iterations will occur on the correlation engine's cache and contains the definition of said iterations.
*   **search**: Used when the analysis period exceeds 1 hour or the rule's complexity is very high, making cache-based analysis impractical.

#### Operators

Various logical and mathematical operators are available for field validation and filtering within correlation rules:

*   **`==`**: True if the field's content is exactly equal to the value.
*   **`!=`**: True if the field's content is not equal to the value.
*   **`regexp`**: True if the field's content matches the regular expression in the value.
*   **`not regexp`**: True if the field's content does not match the regular expression in the value.
*   **`exist`**: True if the field exists. The value must be left empty.
*   **`not exist`**: True if the field does not exist. The value must be left empty.
*   **`in cidr`**: True if the IP address in the field is within the specified CIDR range.
*   **`not in cidr`**: True if the IP address in the field is not within the specified CIDR range.

**Classic mathematical operators (apply only to numeric fields and values):**

*   `<` (less than)
*   `>` (greater than)
*   `<=` (less than or equal to)
*   `>=` (greater than or equal to)

#### When to use Cache or Search

*   **Cache**: Recommended for rules that will analyze logs within a maximum period of 1 hour.
*   **Search**: Recommended when the analysis period exceeds 1 hour or when the rule's complexity is very high and cannot be effectively implemented using the cache.

### Tutorial: Detecting Multiple Failed Windows Login Attempts

This example demonstrates how to set up an automated correlation rule to detect multiple failed Windows authentication attempts, which can indicate a brute-force password guessing attack.

#### Scenario

A Windows user is unable to authenticate with a server or workstation more than 5 times within a 60-second window, following an initial failed attempt within a 15-second window. This scenario is indicative of a brute-force attack.

#### Rule Example

```yaml
- name: Windows authentication failure
  severity: Low
  description: A Windows user was unable to authenticate with the server or workstation more than 5 times.
  solution: Refer to NIST guidelines when creating password policies and set account lockout policies after a certain number of failed login attempts to prevent passwords from being guessed. Too strict a policy may create a denial of service condition and render environments un-usable, with all accounts used in the brute force being locked-out.
  category: User Account Authentication
  tactic: "Brute Force: Password Guessing"
  dataTypes: ["wineventlog"]
  reference:
    - "https://attack.mitre.org/techniques/T1110/001/"
  frequency: 10
  cache:
    - allOf:
        - field: logx.wineventlog.event_id
          operator: "=="
          value: 4625
      minCount: 1
      timeLapse: 15
      save:
        - field: logx.wineventlog.event_data.TargetUserName
          alias: DestinationUser
        - field: logx.wineventlog.host.name
          alias: DestinationHost
    - allOf:
        - field: logx.wineventlog.event_id
          operator: "=="
          value: 4625
        - field: logx.wineventlog.event_data.TargetUserName
          operator: "=="
          value: "{{.DestinationUser}}"
        - field: logx.wineventlog.host.name
          operator: "=="
          value: "{{.DestinationHost}}"
      minCount: 5
      timeLapse: 60
      save:
        - field: logx.wineventlog.event_data.TargetUserName
          alias: DestinationUser
        - field: logx.wineventlog.host.name
          alias: DestinationHost
        - field: logx.wineventlog.event_data.WorkstationName
          alias: SourceHost
        - field: logx.wineventlog.event_data.IpAddress
          alias: SourceIP
```

**Explanation of the Rule:**

*   **`name`**: Identifies the alert as "Windows authentication failure."
*   **`severity`**: Set to `Low`.
*   **`description`**: Provides context about the alert.
*   **`solution`**: Recommends NIST guidelines for password policies and account lockout policies.
*   **`category`**: Groups the alert under "User Account Authentication."
*   **`tactic`**: Maps the incident to "Brute Force: Password Guessing" from the MITRE ATT&CK framework.
*   **`dataTypes`**: Specifies that this rule applies to `wineventlog` data.
*   **`frequency`**: The rule is checked every 10 seconds.
*   **`cache`**: Defines two stages of correlation:
    *   **Stage 1 (Initial Failure)**: Looks for at least one `event_id` 4625 (Windows authentication failure) within 15 seconds. It saves the `TargetUserName` as `DestinationUser` and `host.name` as `DestinationHost` for the subsequent stage.
    *   **Stage 2 (Multiple Failures)**: After an initial failure, it then looks for at least 5 additional `event_id` 4625 events within 60 seconds, specifically for the `DestinationUser` on the `DestinationHost` identified in Stage 1. It saves additional fields like `WorkstationName` (as `SourceHost`) and `IpAddress` (as `SourceIP`) for detailed incident investigation.

### Integration with UTMStack Features

Correlation rules are integral to UTMStack's unified platform. They work in conjunction with other modules such as:

*   **Log Explorer**: Enables users to analyze, filter, and save customized queries for various log events, including login failures (e.g., Office 365 login activities). This module helps in understanding the underlying log data that correlation rules process.
*   **Threat Management**: Alerts generated by correlation rules feed into the Alert Management system, allowing for incident response, false positive management, and leveraging threat intelligence.
*   **Compliance Management**: Correlation rules contribute to compliance by detecting security events that may violate regulatory requirements, supporting the generation of compliance reports.

### Summary

Automated Log Correlation Rules are a cornerstone of UTMStack's advanced threat detection capabilities. By leveraging a comprehensive set of rules and a powerful correlation engine, UTMStack can analyze vast amounts of log data in real time, identify complex attack patterns like brute-force attempts, and generate timely alerts. These rules are highly customizable, allowing organizations to define specific conditions and actions to protect their hybrid environments and ensure continuous security and compliance.