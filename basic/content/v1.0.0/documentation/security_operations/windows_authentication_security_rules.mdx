# Windows Authentication Security Rules

This documentation provides guidance on creating and implementing security rules within UTMStack to detect failed Windows authentication attempts, which can indicate potential brute-force password guessing attacks. By leveraging UTMStack's powerful correlation engines, organizations can monitor and respond to suspicious activity related to user authentication.

## UTMStack's Threat Detection Capabilities

UTMStack is a Unified Threat Management Platform designed to deliver essential security services, including robust threat detection and response. Its threat detection engine incorporates several rule-based correlation systems, scanners, and AI-powered machine learning algorithms. The platform leverages powerful correlation engines with a total of 154,000 detection rules to aggregate, correlate, and analyze log data, network traffic, and system internal activity generated by on-premises and cloud devices or SaaS. This enables the system to learn from the environment and identify abnormal and threatening behavior.

## Windows Authentication Failure Security Rule

A critical aspect of security monitoring is identifying repeated failed authentication attempts, which often precede successful breaches or indicate ongoing brute-force attacks. UTMStack provides a specific rule to detect such activities for Windows environments.

### Rule Details

The "Windows authentication failure" rule is designed to alert when a Windows user is unable to authenticate with a server or workstation more than 5 times.

*   **Name**: Windows authentication failure
*   **Severity**: Low
*   **Description**: A Windows user was unable to authenticate with the server or workstation more than 5 times.
*   **Solution**: Refer to NIST guidelines when creating password policies and set account lockout policies after a certain number of failed login attempts to prevent passwords from being guessed. It is important to note that too strict a policy may create a denial of service condition and render environments unusable, with all accounts used in the brute force being locked out.
*   **Category**: User Account Authentication
*   **Tactic**: Brute Force: Password Guessing
*   **Data Types**: `wineventlog`
*   **Reference**: `https://attack.mitre.org/techniques/T1110/001/`
*   **Frequency**: 10

### Rule Logic

This rule utilizes the Windows Event ID `4625`, which signifies a failed logon attempt, to track and correlate multiple failures. The rule definition uses a `cache` mechanism to efficiently monitor authentication events over specific timeframes.

```yaml
- name: Windows authentication failure
  severity: Low
  description: A Windows user was unable to authenticate with the server or workstation more than 5 times.
  solution: Refer to NIST guidelines when creating password policies and set account lockout policies after a certain number of failed login attempts to prevent passwords from being guessed. Too strict a policy may create a denial of service condition and render environments un-usable, with all accounts used in the brute force being locked-out.
  category: User Account Authentication
  tactic: "Brute Force: Password Guessing"
  dataTypes: ["wineventlog"]
  reference:
    - "https://attack.mitre.org/techniques/T1110/001/"
  frequency: 10
  cache:
    - allOf:
        - field: logx.wineventlog.event_id
          operator: "=="
          value: 4625
      minCount: 1
      timeLapse: 15
      save:
        - field: logx.wineventlog.event_data.TargetUserName
          alias: DestinationUser
        - field: logx.wineventlog.host.name
          alias: DestinationHost
    - allOf:
        - field: logx.wineventlog.event_id
          operator: "=="
          value: 4625
        - field: logx.wineventlog.event_data.TargetUserName
          operator: "=="
          value: "{{.DestinationUser}}"
        - field: logx.wineventlog.host.name
          operator: "=="
          value: "{{.DestinationHost}}"
      minCount: 5
      timeLapse: 60
      save:
        - field: logx.wineventlog.event_data.TargetUserName
          alias: DestinationUser
        - field: logx.wineventlog.host.name
          alias: DestinationHost
        - field: logx.wineventlog.event_data.WorkstationName
          alias: SourceHost
        - field: logx.wineventlog.event_data.IpAddress
          alias: SourceIP
```

The rule also supports a `search` configuration for broader analysis:

```yaml
  search:
    - query: '{"size": 500, "query": {"bool": {"must": [{"match_phrase": {"logx.wineventlog.event_id": 4625}}], "filter": [{"range": {"@'
```

### Recommended Solution

Upon detection of multiple Windows authentication failures, it is recommended to:
*   **Refer to NIST guidelines**: Implement strong password policies in alignment with NIST guidelines.
*   **Set account lockout policies**: Configure account lockout policies after a specific number of failed login attempts to prevent password guessing attacks. Care should be taken not to make these policies too strict, as this could lead to a denial of service condition if legitimate accounts are locked out due to a sustained brute-force attempt.

## Rule Configuration Elements

When defining security rules in UTMStack, various operators and analysis methods can be employed.

### Logical Operators

*   **exist**: Returns true if the specified field exists. The value must be left empty.
*   **not exist**: Returns true if the specified field does not exist. The value must be left empty.
*   **in cidr**: Returns true if the IP address in the field is within the specified CIDR range.
*   **not in cidr**: Returns true if the IP address in the field is not within the specified CIDR range.

### Numeric Operators

These operators apply only to numeric fields and values:
*   `<` (less than)
*   `>` (greater than)
*   `<=` (less than or equal to)
*   `>=` (greater than or equal to)

### When to use Cache or Search

*   **Cache**: Recommended for rules that analyze logs within a maximum timeframe of 1 hour.
*   **Search**: Recommended when the analysis period exceeds 1 hour or when the rule's complexity is very high and cannot be efficiently handled using the cache.

## Summary

UTMStack provides a robust framework for detecting Windows authentication failures and potential brute-force attacks through its rule-based correlation engine. By configuring rules to monitor Windows Event ID 4625 for multiple failed login attempts, organizations can identify suspicious activity. The platform offers flexible rule configuration using logical and numeric operators, along with options for cache-based or search-based analysis depending on the monitoring requirements. Implementing the recommended solutions, such as strong password policies and balanced account lockout policies, is crucial for mitigating the risks associated with these threats.